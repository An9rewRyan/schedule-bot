global_env:
  PYTHONPATH: .
  ENVIRONMENT: development

startup_order: [ngrok, backend, frontend, telegram_bot]

hooks:
  pre_start:
    - echo "Запуск Mini App Development Server"
    - echo "Подготовка к запуску сервисов..."

  post_start:
    - echo "Все сервисы запущены!"
    - echo "Логи отображаются ниже. Нажмите Ctrl+C для остановки."

  after_ngrok_start:
    - sleep 3
    - python scripts/update_ngrok_configs.py

services:
  ngrok:
    command: ngrok start --config ngrok.yml --all --log stdout
    working_dir: .
    color: cyan
    startup_delay: 0
    enabled: true
    restart_on_failure: false
    post_start_hook: after_ngrok_start
    health_check:
      type: http
      url: http://localhost:4040/api/tunnels
      timeout: 3

  backend:
    command: python -m uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
    working_dir: backend
    color: green
    startup_delay: 8
    depends_on: [ngrok]
    enabled: true
    restart_on_failure: true
    max_restarts: 3
    env:
      PORT: "8000"

  frontend:
    command: python server.py
    working_dir: frontend
    color: blue
    startup_delay: 1
    depends_on: [backend]
    enabled: true
    restart_on_failure: false

  telegram_bot:
    command: python main.py
    working_dir: tg_bot
    color: magenta
    startup_delay: 2
    depends_on: [backend]
    enabled: true
    restart_on_failure: true
    max_restarts: 5