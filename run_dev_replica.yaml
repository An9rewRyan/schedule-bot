global_env:
  PYTHONPATH: .
  ENVIRONMENT: development

# –ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ (–≤–∞–∂–Ω–æ: ngrok –ø–µ—Ä–≤—ã–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è URLs)
startup_order: [ngrok, backend, frontend, telegram_bot]

hooks:
  # –•—É–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏
  pre_start:
    - echo "üöÄ –ó–∞–ø—É—Å–∫ Mini App Development Server"
    - echo "üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–∏—Å–æ–≤..."

  post_start:
    - echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!"
    - echo "üìù –õ–æ–≥–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∏–∂–µ. –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏."

  # –•—É–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ ngrok
  after_ngrok_start:
    - sleep 3  # –î–∞–µ–º –≤—Ä–µ–º—è ngrok –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
    - python scripts/update_ngrok_configs.py  # –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

services:
  # ngrok –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º
  ngrok:
    command: ngrok start --config ngrok.yml --all --log stdout
    working_dir: .
    color: cyan
    startup_delay: 0
    enabled: true
    restart_on_failure: false
    post_start_hook: after_ngrok_start  # –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ ngrok –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    health_check:
      type: http
      url: http://localhost:4040/api/tunnels
      timeout: 3

  # Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ ngrok –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CORS
  backend:
    command: python -m uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
    working_dir: backend
    color: green
    startup_delay: 8  # –î–∞–µ–º –≤—Ä–µ–º—è ngrok –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    depends_on: [ngrok]  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç ngrok –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CORS
    enabled: true
    restart_on_failure: true
    max_restarts: 3
    env:
      PORT: "8000"

  # Frontend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ backend
  frontend:
    command: python server.py
    working_dir: frontend
    color: blue
    startup_delay: 1
    depends_on: [backend]
    enabled: true
    restart_on_failure: false

  # Telegram bot –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º
  telegram_bot:
    command: python main.py
    working_dir: tg_bot
    color: magenta
    startup_delay: 2
    depends_on: [backend]
    enabled: true
    restart_on_failure: true
    max_restarts: 5